# 3.5 카프카 스트림즈
카프카 스트림즈는 토픽에 적재된 데이터를 상태기반 또는 비상태기반으로 실시간 변환하여 다른 토픽에 적재하는 라이브러리이다.
![image](https://github.com/user-attachments/assets/e3ac5675-5055-4f3e-b306-ef0a7a7afb2b)

스트림즈 애플리케이션은 내부적으로 스레드를 1개 이상 생성할 수 있으며, 스레드는 1개 이상의 테스크를 가진다.
실제 운영환경에서는 장애가 발생하더라도 안정적으로 운영할 수 있도록 2개 이상의 서버로 구성하여 스트림즈 애플리케이션을 운영한다.

### 카프카 스트림즈의 구조
카프카 스트림즈의 구조와 사용방법을 알기 위해서는 우선 토폴로지와 관련된 개념을 익혀야 한다.
토폴로지란 2개 이상의 노드들과 선으로 이루어진 집합을 뜻한다. 종류는 링형, 트리형, 성형 등이 있는데 스트림즈에서 사용하는 토폴로지는 `트리 형태`와 유사하다.
카프카 스트림즈에서는 토폴로지를 이루는 노드를 하나의 `프로세서` 라고 부르고 노드와 노드를 이은 선을 `스트림` 이라고 부른다.
스트림은 토픽의 데이터를 뜻하는데 레코드와 동일하다. 프로세서에는 소스 프로세서, 스트림 프로세서, 싱크 프로세서가 있다. 소스 프로세서 -> 스트림 프로세서 -> 싱크 프로세서 로 실행 된다.
1. 소스 프로세서
   - 데이터를 처리하기 위해 최초로 선언해야 하는 노드로, 하나 이상의 토픽에서 데이터를 가져오는 역할
2. 스트림 프로세서
   - 다른 프로세서가 반환한 데이터를 처리하는 역할
3. 싱크 프로세서
   - 데이터를 특정 카프카 토픽으로 저장하는 역할

카프카 스트림즈는 스트림즈 DSL 또는 프로세서 API 방법으로 개발 가능하다.

## 3.5.1 스트림즈DSL
스트림즈DSL에는 레코드의 흐름을 추상화한 3가지 개념인 KStream, KTable, GlobalKTable이 있다. 이 3가지 개념은 컨슈머, 프로듀서, 프로세서 API에서는 사용되지 않고 스트림즈DSL에서만 사용되는 개념이다.

### KStream
Kstream은 레코드의 흐름을 표현한 것으로 메시지 키와 메시지 값으로 구성되어 있다.
데이터를 조회하면 토픽에 존재하는 모든 레코드가 출력된다.

### KTable
Ktable은 Kstream과 다르게 메시지 키를 기준으로 묶어서 사용한다.
Ktable은 유니크한 메시지 키를 기준으로 가장 최신 레코드를 사용한다. 중복되는 메시지 키가 있다면 최신 들어오는 레코드로 업데이트 된다.

### GlobalKTable
GlobalKTTable은 KTable과 동일하게 메시지 키를 기준으로 묶어서 사용된다. 
그러나 KTable로 선언된 토픽은 1개 파티션이 1개 테스크에 할당되어 사용되고, GlobalKTable로 선언된 토픽은 모든 파티션 데이터가 각 태스크에 할당되어 사용된다는 차이점이 있다.

### 스트림즈DSL 주요 옵션
- 필수 옵션
  - bootstrap.servers
  - application.id
- 선택 옵션
  - default.key.serde : 레코드의 메시지 키를 직렬화, 역직렬화하는 클래스를 지정한다.
  - default.value.serde : 레코드의 값 키를 직렬화, 역직렬화하는 클래스를 지정한다.
  - num.stream.threads : 스트림 프로세싱 실행 시 실행될 스레드 개수를 지정한다. 기본값은 1이다.
  - state.dir : rocksDB 저장소가 위치할 디렉토리르 지정한다.

### 스트림즈DSL - stream(), to()
스트림즈DSL로 구현할 수 있는 가장 간단한 스트림 프로세싱은 특정 토픽의 데이터를 다른 토픽으로 전달하는 것이다.

### 스트림즈DSL - filter()
토픽으로 들어온 메시지 키 또는 메시지 값의 조건에 따라 데이터를 필터링할 수 있다. filter() 메서드는 스트림즈DSL에서 사용 가능한 필터링 스트림 프로세서이다.

### 스트림즈DSL - KTable과 KStream을 join()
Ktable과 KStream을 조인할 때 가장 중요한 것은 코파티셔닝이 되어 있는지 확인하는 것이다. 실습 실패함..

## 프로세서 API
프로세서 API는 스트림즈DSL보다 투박한 코드를 가지지만 토폴로지를 기준으로 데이터를 처리한다는 관점에서는 동일한 역할을 한다.
스트림즈DSL은 데이터 처리, 분기, 조인을 위한 다양한 메서드들을 제공하지만 추가적인 상세 로직의 구현이 필요하다면 프로세서 API를 활용할 수 있다.