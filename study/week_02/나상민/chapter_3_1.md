# 3.1 카프카 브로커,클러스터,주키퍼
카프카 브로커는 카프카 클라이언트와 데이터를 주고받기 위해 사용되는 주체이자, 데이터를 분산 저장하여 장애가 발생하더라도 안전하게 사용할 수 있도록 도와주는 애플리케이션이다.

하나의 서버에는 한 개의 카프카 브로커 프로세스가 실행된다.

카프카 클러스터는 여러 개의 카프카 브로커로 구성되어 있으며, 클러스터 내의 브로커들은 데이터를 공유하고 서로 복제하여 안전하게 데이터를 보관한다.

## 데이터 저장, 전송
카프카는 메모리나 데이터베이스에 저장하지 않으며 따로 캐시메모리를 구현하여 사용하지도 않는다. 파일 시스템에 저장한다. 파일 시스템이기 때문에 힙 메모리 사이즈를 크게 설정할 필요가 없다.

카프카는 페이지 캐시를 사용하여 입출력 속도를 높였다. 페이지 캐시는 파일 시스템이 사용하는 메모리 공간으로, 파일을 읽거나 쓸 때 사용된다.

## 데이터 복제, 싱크
카프카의 데이터 복제는 파티션 단위로 이루어진다. 토픽을 생성할 때 파티션의 복제 갯수도 같이 설정되는데 직접 옵션을 선택하지 않으면 브로커에 설정된 옵션에 따라간다. 복제 개수의 최솟값은 1(복제 없음)이고 최댓값은 브로커 개수만큼이다.

프로듀서 또는 컨슈머와 직접 통신하는 파티션을 리더, 나머지 복제 데이터를 가지고 있는 파티션을 팔로워라고 부른다.

팔로우 파티션은 리더 파티션의 오프셋을 확인하여 현재 자신이 가지고 있는 오프셋과 차이가 나는 경우 리더 파티션으로부터 데이터를 가져와서 자신의 파티션에 저장하는데 이 과정을 복제라고 한다.

만약에 리더 파티션이 다운되면 다른 팔로워 파티션이 리더 파티션 지위를 받는다.

## 컨트롤러
클러스터의 다수 브로커 중 한 대가 컨트롤러의 역할을 한다. 컨트롤러는 클러스터 내의 모든 브로커의 상태를 관리하고 리더 파티션을 선출하는 역할을 한다.

## 데이터 삭제
카프카는 컨슈머가 데이터를 가지고 가더라도 데이터를 삭제하지 않는다. 데이터를 삭제하려면 브로커가 직접 데이터를 삭제해야 한다. 데이터 삭제는 파일 단위로 이루어지는데 이 단위를 로그 세그먼트라고 한다.

## 컨슈머 오프셋 저장
컨슈머 그룹은 토픽이 특정 파티션으로부터 데이터를 가져가서 처리하고 이 파티션의 어느 레코드까지 가져갔는지 확인하기 위해 오프셋을 커밋한다.

## 코디네이터
클러스터의 다수 브로커 중 한 대는 코디네이터의 역할을 수행한다. 코디네이터는 컨슈머 그룹의 상태를 체크하고 파티션을 컨슈머와 매칭되도록 분배하는 역할을 한다. 이렇게 파티션을 재할당하는 과정을 리밸런스라고 부른다.

