# 4.2 카프카 프로듀서
## 4.2.1 acks 옵션
카프카 프로듀서의 acks 옵션은 0,1,all 세 가지 옵션이 있다.
이 옵션을 통해 프로듀서가 전송한 데이터가 카프카 클러스터에 얼마나 신뢰성 높게 저장할지 지정할 수 있다.
### acks=0
acks를 0으로 설정하는 것은 프로듀서가 리더 파티션으로 데이터를 전송했을 때 리더 파티션으로 데이터가 저장되었는지 확인하지 않는다는 뜻이다.
즉, 프로듀서가 데이터를 전송하면 응답 값을 받지 않고 전송이 성공했다고 판단한다.
데이터가 일부 유실이 발생하더라도 전송 속도가 중요한 경우에는 이 옵션값을 사용하면 좋다.
### acks=1
acks를 1로 설정하면 프로듀서가 리더 파티션으로 데이터를 전송했을 때 리더 파티션에 데이터가 저장되었는지 확인한다.
### acks=all 또는 acks=-1
acks를 all 또는 -1로 설정하면 프로듀서가 리더 파티션으로 데이터를 전송했을 때 리더 파티션과 팔로워 파티션 모두에 데이터가 저장되었는지 확인한다.
속도가 느리지만 일부 브로커에 장애가 발생하더라도 프로듀서는 안전하게 데이터를 전송하고 저장할 수 있음을 보장한다.

토픽 단위로 설정 가능한 `min.insync.replicas` 옵션값에 따라 데이터의 안정성이 달라진다.
`min.insync.replicas`옵션은 프로듀서가 리더 파티션과 팔로워 파티션에 데이터가 적재되었는지 확인하기 위한 최소 ISR그룹의 파티션 개수이다.

`min.insync.replicas`옵션을 설정할 때는 복제 개수도 함께 고려해야 한다. 왜냐하면 운영하는 카프카 브로커 개수가 min.insync.replicas 옵션값보다 적다면 데이터의 안정성을 보장할 수 없기 때문이다.

토픽의 복제 개수는 3, min.insync.replicas 옵션값은 2로 설정하고 프로듀서는 acks를 all로 설정하는것을 추천한다.

## 4.2.2 멱등성 프로듀서
멱등성이란 여러 번 연산을 수행하더라도 동일한 결과를 나타내는 것을 뜻한다.
프로듀서가 보내는 데이터의 중복 적재를 막기 위해 0.11.0 이후 버전부터는 프로듀서에서 enable.idempotence 옵션을 사용하여 정확히 한번 전달을 지원한다.
기본값은 false이다.
멱등성 프로듀서는 기본 프로듀서와 달리 데이터를 브로커에 전달할 때 프로듀서 PID와 시퀀스 넘버를 함께 전달한다.

단, 멱등성 프로듀서는 동일한 세션에서만 정확히 한번 전달을 보장한다. 여기서 말하는 동일한 세션이란 PID의 생명주기를 뜻한다.
만약 멱등성 프로듀서로 동작하는 프로듀서 애플리케이션에 이슈가 발생하여 종료되고 애플리케이션을 재시작하면 PID가 변경되어 이전에 전송한 데이터가 중복 적재될 수 있다.
그래서 멱등성 프로듀서는 장애가 발생하지 않을 경우에만 정확히 한 번 적재하는 것을 보장한다.

enable.idempotence 옵션을 사용하면 retries 옵션을 Integer.MAX_VALUE로 설정하고 acks 옵션을 all로 설정된다.
이렇게 설정되는 이유는 프로듀서가 적어도 한 번 이상 브로커에 데이터를 보냄으로써 브로커에 단 한 번만 데이터가 적재되는 것을 보장하기 위해서다.

시퀀스 넘버는 0부터 시작하여 숫자를 1씩 더한 값이 전달되는데 브로커에서 멱등성 프로듀서가 전송한 데이터의 PID와 시퀀스 넘버를 확인하는 과정에서 시퀀스 넘버가 일정하지 않은 경우에는 OutOfOrderSequenceException이 발생한다.
OutOfOrderSequenceException가 발생했을 경우에는 시퀀스 넘버의 역전현상이 발생할 수 있기 때문에 순서가 중요한 데이터를 전송하는 프로듀서는 해당 Exception이 발생한 경우 대응하는 방안을 고려해야 한다.

## 4.2.3 트랜잭션 프로듀서
카프카의 트랜잭션 프로듀서는 다수의 파티션에 데이터를 저장할 경우 모든 데이터에 대해 동일한 원자성을 만족시키기 위해 사용된다.
컨슈머는 기본적으로 프로듀서가 보내는 데이터가 파티션에 쌓이는 대로 모두 가져가서 처리한다.

그러나 트랜잭션으로 묶인 데이터를 브로커에서 가져갈 때는 다르게 동작하도록 설정할 수 있다.
트랜잭션 프로듀서를 사용하려면 `enable.idempotence` 옵션을 true로 설정하고 `transactional.id`를 임의의 String값으로 정의한다.
그리고 컨슈머의 isolation.level을 read_committed로 설정하면 프로듀서와 컨슈머는 트랜잭션으로 처리 완료된 데이터만 쓰고 읽게 된다.

트랜잭션은 파티션의 레코드로 구분한다. 트랜잭션 프로듀서는 사용자가 보낸 데이터를 레코드로 파티션에 저장할 뿐만 아니라 트랜잭션의 시작과 끝을 표현하기 위해 트랜잭션 레코드를 한 개 더 보낸다.
트랜잭션 컨슈머는 파티션에 저장된 트랜잭션 레코드를 보고 트랜잭션이 완료 되었음을 확인하고 데이터를 가져간다.